[tox]
minversion = 3.23.0
requires =
    virtualenv >= 20.4.3
    tox < 4.0.0
    tox-wheel >= 0.6.0
isolated_build = true
envlist =
    flake8,
    tests,
    apidocs


[testenv]
wheel = true
wheel_build_env = build
deps =
    tests: coverage
    apidocs: pydoctor
    lint: pre-commit
extras =
    mypy: mypy
    tests: scripts

commands =
    python -V

    lint: pre-commit run --all-files --show-diff-on-failure

    apidocs: pydoctor -q --project-name incremental src/incremental

    tests: coverage --version
    tests: {envbindir}/trial --version
    tests: coverage erase
    tests: {envpython} -c "import site; open(site.getsitepackages()[0] + '/coveragehack.pth', 'w').write('import coverage; coverage.process_startup()')"
    tests: coverage run -p {envbindir}/trial incremental
    tests: coverage run -p -m pip install --use-pep517 ./tests/example_setuppy
    tests: coverage run -p -m pip install --use-pep517 ./tests/example_setuptools
    tests: coverage run -p {envbindir}/trial tests/test_examples.py
    tests: coverage combine
    tests: coverage report
    tests: coverage html
    tests: coverage xml

    mypy: mypy src


[testenv:build]
# empty environment to build universal wheel once per tox invocation
# https://github.com/ionelmc/tox-wheel#build-configuration
